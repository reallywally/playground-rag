# 하이브리드 검색

하이브리드 검색이 뭔지 몰라서 하이브리드 검색 구현이 뭔지랑 코드를 완전 초보자 에게 설명 해주는 것처럼 설명해줘 라고 질문하고 받은 답변이다.

## 하이브리드 검색이란? 🔍

기존 방식의 문제점

기존 코드에서는 유사도 검색만 사용했습니다:

## 기존 방식 (services/chat_service.py:83-86)

vectorstore = pdf_service.get_vectorstore()
retriever = vectorstore.as_retriever(
search_type="similarity", # 유사도 검색만!
search_kwargs={"k": settings.SEARCH_K}
)

유사도 검색의 한계:

- "파이썬"을 검색해도 "Python"이나 "programming"만 나올 수 있음
- 정확한 키워드 매칭이 어려움
- 문맥은 비슷하지만 핵심 단어가 다른 경우 놓칠 수 있음

---
하이브리드 검색 = 두 가지 검색 방식의 결합 🤝

1. 유사도 검색 (Semantic Search)

## 벡터로 변환된 의미를 비교

"파이썬 프로그래밍" → [0.1, 0.8, 0.3, ...] (벡터)
"Python coding"   → [0.2, 0.7, 0.4, ...] (벡터)

## 벡터 간 거리를 계산해서 의미상 비슷한 문서 찾기

2. 키워드 검색 (BM25)

## 정확한 단어 매칭

"파이썬" 검색 → "파이썬"이 포함된 문서만 찾기
"Python" 검색 → "Python"이 포함된 문서만 찾기

---
개선된 코드 분석 📋

1. 설정 파일에 하이브리드 검색 옵션 추가

## config/settings.py

HYBRID_SEARCH_WEIGHT: float = 0.7 # 유사도 검색 가중치

## 0.7 = 유사도 검색 70%, 키워드 검색 30%

2. PDF 서비스에서 두 검색기 모두 생성

## services/pdf_service.py

def __init__(self):
self.vectorstores = {} # 유사도 검색용
self.bm25_retrievers = {} # 키워드 검색용
self.ensemble_retrievers = {} # 두 검색을 합친 것!

PDF 처리 시 두 검색기 모두 만들기:

## 1. 벡터스토어 (유사도 검색)

vectorstore = Chroma.from_documents(
documents=split_documents,
embedding=self.embeddings, # 문서를 벡터로 변환
)

## 2. BM25 검색기 (키워드 검색)

bm25_retriever = BM25Retriever.from_documents(split_documents)

## 3. 두 개를 합친 하이브리드 검색기!

ensemble_retriever = EnsembleRetriever(
retrievers=[
vectorstore.as_retriever(), # 유사도 검색기
bm25_retriever # 키워드 검색기
],
weights=[0.7, 0.3]  # 70% 유사도, 30% 키워드
)

3. 채팅 서비스에서 하이브리드 검색 사용

## services/chat_service.py

## 기존: vectorstore.as_retriever() 만 사용

## 개선: 하이브리드 검색기 사용!

retriever = pdf_service.get_hybrid_retriever()  # 하이브리드 검색기

## 만약 하이브리드가 없으면 기본 방식 사용 (안전장치)

if retriever is None:
vectorstore = pdf_service.get_vectorstore()
retriever = vectorstore.as_retriever()

---
실제 검색 예시 🎯

사용자 질문: "파이썬에서 리스트 정렬하는 방법"

기존 방식 (유사도만)

검색 결과:

1. "Python data structures and algorithms" (의미는 비슷하지만...)
2. "Programming with arrays and sorting" (정렬은 있지만 파이썬 아님)
3. "List manipulation techniques" (리스트는 있지만 정렬 없음)

하이브리드 방식

유사도 검색 결과 (70%):

1. "Python data structures"
2. "Programming with arrays"
3. "List manipulation"

키워드 검색 결과 (30%):

1. "파이썬 리스트.sort() 메서드" ✅
2. "Python list sorting methods" ✅
3. "리스트 정렬 sorted() 함수" ✅

최종 결합 결과:
→ 정확한 키워드 매칭 + 의미적 유사성 모두 고려!

---
왜 더 좋을까? 🚀

1. 정확성 향상: 키워드 매칭으로 정확한 용어 찾기
2. 유연성 확보: 유사도 검색으로 다양한 표현 커버
3. 가중치 조절: 상황에 따라 비율 조정 가능
4. 검색 누락 감소: 두 방식의 장점을 모두 활용

예를 들어, "머신러닝"을 검색할 때:

- 유사도: "AI", "딥러닝", "인공지능" 등도 찾음
- 키워드: 정확히 "머신러닝"이 적힌 문서를 놓치지 않음

이제 RAG 시스템이 더 똑똑하게 문서를 찾을 수 있습니다! 🎉